<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العملاء - CRP </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fc; /* Light background typical of modern dashboards */
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        /* Input Styles matching the reference images */
        .form-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            outline: none;
            background-color: #ffffff;
        }
        .form-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.25rem;
        }

        /* Upload Zone Style */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            transition: all 0.2s;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scaleIn {
            animation: scaleIn 0.2s ease-out forwards;
        }
        
        .active-nav-item {
            background-color: #1a4b82;
            color: white;
            border-right: 4px solid #e5b57f;
        }
        .inactive-nav-item {
            color: #dbeafe; /* blue-100 */
            border-right: 4px solid transparent;
        }
        .inactive-nav-item:hover {
            background-color: #0a2342;
            color: white;
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-[#0f3057] text-white w-64 flex-shrink-0 flex flex-col transition-all duration-300 shadow-2xl z-20 h-full md:relative absolute transform -translate-x-full md:translate-x-0">
        <div class="p-6 flex flex-col items-center border-b border-blue-900/50">
            <!-- Logo -->
            <div class="w-20 h-20 mb-3 bg-[#fdf6e7] rounded-2xl flex items-center justify-center shadow-lg relative overflow-hidden transform rotate-3 hover:rotate-0 transition-transform duration-300">
                <svg viewBox="0 0 100 100" class="w-full h-full p-1">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-wider text-center font-sans">IN ONE OPERATION</h1>
            <p class="text-[10px] text-blue-200 mt-1 uppercase tracking-widest opacity-80">System Management</p>
        </div>

        <nav class="flex-1 px-3 space-y-1.5 mt-6 overflow-y-auto custom-scrollbar">
            <!-- Navigation Items -->
            <button onclick="switchTab('registration')" id="nav-registration" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 active-nav-item group">
                <i data-lucide="user-check" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">تسجيل العملاء</span>
            </button>
            <button onclick="switchTab('measurements')" id="nav-measurements" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="ruler" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">أخذ المقاسات</span>
            </button>
            <button onclick="switchTab('design')" id="nav-design" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="pen-tool" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">التصميم والتسعير</span>
            </button>
            <button onclick="switchTab('installation')" id="nav-installation" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="hammer" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">مرحلة التركيب</span>
            </button>
            
            <div class="my-3 border-t border-blue-800/30 mx-2"></div>
            
            <button onclick="switchTab('offers')" id="nav-offers" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="file-text" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">العروض والفواتير</span>
            </button>
            <button onclick="switchTab('reports')" id="nav-reports" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">التقارير</span>
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 bg-[#0a2342]/80 backdrop-blur-sm mt-auto border-t border-blue-800/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center font-bold text-white shadow-md border border-white/10 relative">
                    خ
                    <span id="role-indicator" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 border-2 border-[#0a2342] rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate" id="user-name">خالد رمزي</p>
                    <p class="text-[10px] text-blue-300 truncate" id="user-role">مدير النظام</p>
                </div>
                <button onclick="toggleRole()" class="text-blue-300 hover:text-white p-1.5 rounded-lg hover:bg-white/10 transition-colors" title="تبديل الصلاحية">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-10 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full bg-[#f8f9fc]">
        <!-- Header -->
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10 sticky top-0 border-b border-slate-100">
            <div class="flex items-center gap-4 flex-1">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="relative w-full max-w-lg hidden md:block group">
                    <i data-lucide="search" class="absolute right-3 top-2.5 h-5 w-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="global-search" oninput="handleSearch(this.value)" placeholder="ابحث باسم العميل، رقم الهاتف، أو الكود..." 
                        class="w-full pr-10 pl-4 py-2 bg-slate-50 border border-slate-200 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 rounded-full text-sm transition-all outline-none text-slate-600 placeholder-slate-400">
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="resetData()" class="text-red-500 text-xs hover:bg-red-50 px-3 py-1.5 rounded-full transition-colors hidden md:block font-medium">إعادة تعيين</button>
                
                <button class="relative p-2.5 text-slate-500 hover:bg-slate-50 hover:text-blue-600 rounded-full transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                
                <button onclick="switchTab('registration')" class="hidden md:flex items-center gap-2 text-xs px-4 py-2 bg-[#0f3057] text-white rounded-lg hover:bg-[#1a4b82] transition shadow-sm hover:shadow active:scale-95 font-bold">
                    <i data-lucide="plus" class="w-4 h-4"></i> إضافة عميل
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fadeIn scroll-smooth">
            <!-- Content will be injected via JS -->
        </div>
    </main>

    <!-- Client Detail Modal -->
    <div id="clientModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <!-- Modal content injected via JS -->
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Data & Constants ---
        const EMPLOYEES = [
            { id: 1, name: 'خالد رمزي', role: 'admin' },
            { id: 2, name: 'أحمد مندوب', role: 'sales' }
        ];

        let currentUser = EMPLOYEES[0]; // Start as Admin

        const INITIAL_CLIENTS = [
            { 
                id: 1, code: 'BK-5464', name: 'أحمد محمد', phone: '0501234567', 
                email: 'ahmed@email.com', address: 'الرياض - حي العليا', type: 'شركات',
                source: 'social', status: 'potential', employeeId: 1,
                projectDetails: { kitchen: 1, bedroom: 2, cladding: 0, doors: 5, vanity: 2, tvUnit: 1 },
                measurements: { status: 'pending', date: '', files: [] },
                design: { status: 'pending', total: 0, firstPayment: 0, signed: false },
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                    { date: '2023-10-01', type: 'system', text: 'تم تسجيل العميل' },
                    { date: '2023-10-02', type: 'whatsapp', text: 'تم إرسال رسالة ترحيب' }
                ],
                invoices: []
            },
            { 
                id: 2, code: 'LD-9383', name: 'سارة علي', phone: '0559876543', 
                email: 'sara@email.com', address: 'جدة - الروضة', type: 'أفراد',
                source: 'referral', status: 'design', employeeId: 2,
                projectDetails: { kitchen: 1, bedroom: 0, cladding: 10, doors: 0, vanity: 3, tvUnit: 1 },
                measurements: { status: 'completed', date: '2025-02-15', files: ['croquis.pdf'] },
                design: { status: 'waiting_approval', total: 55000, firstPayment: 20000, signed: false },
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                     { date: '2023-10-05', type: 'system', text: 'تم رفع المقاسات' }
                ],
                invoices: [
                    { id: 101, date: '2025-02-20', amount: 20000, status: 'paid', type: 'دفعة أولى' }
                ]
            }
        ];

        const STATUS_OPTIONS = [
            { id: 'new', label: 'جديد', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { id: 'potential', label: 'محتمل', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            { id: 'measurements', label: 'جاري القياس', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { id: 'design', label: 'مرحلة التصميم', color: 'bg-indigo-100 text-indigo-700 border-indigo-200' },
            { id: 'installation', label: 'مرحلة التركيب', color: 'bg-orange-100 text-orange-700 border-orange-200' },
            { id: 'completed', label: 'مكتمل', color: 'bg-green-100 text-green-700 border-green-200' },
            { id: 'rejected', label: 'مرفوض', color: 'bg-red-100 text-red-700 border-red-200' },
        ];

        // --- State Management ---
        let clients = [];
        let activeTab = 'registration';
        let searchQuery = '';
        
        // Active Selections
        let selectedClientId = null;
        let selectedClientForDesignId = null;
        let selectedClientForInstallId = null;

        let newClientForm = {
            code: generateCode(),
            name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
            type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
            projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
            customProjects: [], // For companies
            notes: '',
            measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
        };

        // --- Initialization ---
        function init() {
            loadClients();
            render();
            lucide.createIcons();
        }

        function loadClients() {
            const saved = localStorage.getItem('crm_clients_data');
            clients = saved ? JSON.parse(saved) : INITIAL_CLIENTS;
        }

        function saveClients() {
            localStorage.setItem('crm_clients_data', JSON.stringify(clients));
            render();
        }

        function generateCode() { return 'BK-' + Math.floor(1000 + Math.random() * 9000); }

        function toggleRole() {
            currentUser = currentUser.role === 'admin' ? EMPLOYEES[1] : EMPLOYEES[0];
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'مدير النظام' : 'مندوب مبيعات';
            document.getElementById('role-indicator').className = `absolute bottom-0 right-0 w-2.5 h-2.5 border-2 border-[#0a2342] rounded-full ${currentUser.role === 'admin' ? 'bg-green-400' : 'bg-yellow-400'}`;
            render();
        }

        function getVisibleClients() {
            let filtered = clients;
            if (currentUser.role !== 'admin') {
                filtered = filtered.filter(c => c.employeeId === currentUser.id);
            }
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.phone.includes(q) || c.code.toLowerCase().includes(q));
            }
            return filtered;
        }

        function switchTab(tabName) {
            activeTab = tabName;
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active-nav-item');
                btn.classList.add('inactive-nav-item');
                const icon = btn.querySelector('i') || btn.querySelector('svg');
                if(icon) {
                    icon.classList.remove('text-[#e5b57f]'); // Remove active color if any
                    icon.classList.add('opacity-70');
                }
            });

            const activeBtn = document.getElementById(`nav-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('inactive-nav-item');
                activeBtn.classList.add('active-nav-item');
                const activeIcon = activeBtn.querySelector('i') || activeBtn.querySelector('svg');
                if(activeIcon) {
                    activeIcon.classList.remove('opacity-70');
                    activeIcon.classList.add('text-[#e5b57f]');
                }
            }
            
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            render();
        }

        function handleSearch(val) {
            searchQuery = val;
            render();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function resetData() {
            if(confirm('هل أنت متأكد؟ سيتم حذف جميع البيانات والعودة للوضع الافتراضي.')) {
                clients = INITIAL_CLIENTS;
                saveClients();
                location.reload();
            }
        }

        // --- Render Views ---

        function render() {
            const container = document.getElementById('content-area');
            const visibleClients = getVisibleClients();
            
            let html = '';
            
            if (activeTab === 'registration') {
                html = renderRegistrationView(visibleClients);
            } else if (activeTab === 'measurements') {
                html = renderMeasurementsView(visibleClients);
            } else if (activeTab === 'design') {
                html = renderDesignView(visibleClients);
            } else if (activeTab === 'installation') {
                html = renderInstallationView(visibleClients);
            } else if (activeTab === 'offers') {
                html = renderOffersView(visibleClients);
            } else if (activeTab === 'reports') {
                html = renderReportsView(clients);
            }

            container.innerHTML = html;
            lucide.createIcons();
            attachInputListeners();
        }

        // 1. Registration View
        function renderRegistrationView(data) {
            return `
                <div class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        ${renderStatCard('إجمالي العملاء', data.length, 'users', 'bg-gradient-to-br from-blue-500 to-blue-600', 'text-white')}
                        ${renderStatCard('مشاريع نشطة', data.filter(c => !['new','completed','rejected'].includes(c.status)).length, 'briefcase', 'bg-white', 'text-slate-800', 'border-l-4 border-yellow-500')}
                        ${renderStatCard('مشاريع مكتملة', data.filter(c => c.status === 'completed').length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('جديد هذا الشهر', data.filter(c => c.status === 'new').length, 'star', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <!-- Add Client Form Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-2 h-full bg-blue-600"></div>
                        <div class="mb-6 flex justify-between items-center border-b border-slate-100 pb-4">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="user-plus" class="text-blue-600 w-6 h-6"></i>
                                بيانات العميل الجديد
                            </h2>
                            <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">ID: ${newClientForm.code}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-6">
                            <div class="space-y-1">
                                <label class="form-label">الاسم الكامل <span class="text-red-500">*</span></label>
                                <input type="text" id="in-name" value="${newClientForm.name}" class="form-input" placeholder="اسم العميل...">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم الجوال <span class="text-red-500">*</span></label>
                                <input type="text" id="in-phone" value="${newClientForm.phone}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم واتساب</label>
                                <input type="text" id="in-whatsapp" value="${newClientForm.whatsapp}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">نوع العميل</label>
                                <select id="in-type" class="form-input bg-white">
                                    <option ${newClientForm.type === 'أفراد' ? 'selected' : ''}>أفراد</option>
                                    <option ${newClientForm.type === 'شركات' ? 'selected' : ''}>شركات</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" id="in-email" value="${newClientForm.email}" class="form-input" placeholder="example@mail.com">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">المصدر</label>
                                <select id="in-source" class="form-input bg-white">
                                    <option value="social" ${newClientForm.source === 'social' ? 'selected' : ''}>سوشيال ميديا</option>
                                    <option value="showroom" ${newClientForm.source === 'showroom' ? 'selected' : ''}>زيارة المعرض</option>
                                    <option value="website" ${newClientForm.source === 'website' ? 'selected' : ''}>موقع الكترونى</option>
                                    <option value="referral" ${newClientForm.source === 'referral' ? 'selected' : ''}>عن طريق صديق</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">الرقم الضريبي</label>
                                <input type="text" id="in-tax" value="${newClientForm.taxId}" class="form-input font-mono" placeholder="الرقم الضريبي للعميل">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">حالة العميل</label>
                                <select id="in-status" class="form-input bg-white">
                                    <option value="potential" ${newClientForm.clientStatus === 'potential' ? 'selected' : ''}>محتمل</option>
                                    <option value="interested" ${newClientForm.clientStatus === 'interested' ? 'selected' : ''}>مهتم</option>
                                    <option value="inquiry" ${newClientForm.clientStatus === 'inquiry' ? 'selected' : ''}>استفسار</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رابط اللوكيشن</label>
                                <input type="url" id="in-location" value="${newClientForm.location}" class="form-input text-left dir-ltr" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="md:col-span-3 space-y-1">
                                <label class="form-label">العنوان</label>
                                <input type="text" id="in-address" value="${newClientForm.address}" class="form-input" placeholder="المدينة، الحي...">
                            </div>
                        </div>

                        <!-- Project Details Counter -->
                        <div class="bg-slate-50 p-5 rounded-xl border border-dashed border-slate-300 mb-6">
                            <label class="text-sm font-bold text-slate-600 mb-4 block flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4 text-blue-500"></i> تفاصيل المشروع المطلوبة:
                            </label>
                            ${newClientForm.type === 'أفراد' ? `
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                    ${renderCounter('مطبخ', 'kitchen')}
                                    ${renderCounter('غرفة نوم', 'bedroom')}
                                    ${renderCounter('تجليد', 'cladding')}
                                    ${renderCounter('وحدة TV', 'tvUnit')}
                                    ${renderCounter('أبواب', 'doors')}
                                    ${renderCounter('خزائن', 'vanity')}
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    <div class="flex gap-2 items-end">
                                        <div class="flex-1">
                                            <label class="text-xs text-slate-500 mb-1 block">اسم البند</label>
                                            <input type="text" id="comp-item-name" class="form-input" placeholder="مثال: مكتبة، دولاب..">
                                        </div>
                                        <div class="w-24">
                                            <label class="text-xs text-slate-500 mb-1 block">العدد</label>
                                            <input type="number" id="comp-item-qty" class="form-input" placeholder="0">
                                        </div>
                                        <button onclick="addCompanyItem()" class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 transition-colors h-[42px] w-[42px] flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                    </div>
                                    <div class="space-y-2 mt-3">
                                        ${newClientForm.customProjects.map((item, idx) => `
                                            <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                                <span class="font-medium text-slate-700">${item.name}</span>
                                                <div class="flex items-center gap-4">
                                                    <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">العدد: ${item.qty}</span>
                                                    <button onclick="removeCompanyItem(${idx})" class="text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${newClientForm.customProjects.length === 0 ? '<p class="text-sm text-slate-400 text-center py-2 italic">لم يتم إضافة بنود بعد</p>' : ''}
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Measurement Request Section -->
                        <div class="bg-blue-50/50 p-5 rounded-xl border border-blue-100 mb-6">
                            <label class="text-sm font-bold text-blue-800 mb-4 block flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-4 h-4 text-blue-600"></i> طلب رفع مقاسات (اختياري):
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="in-measure-date" value="${newClientForm.measureRequest.date}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">الوقت</label>
                                    <input type="time" id="in-measure-time" value="${newClientForm.measureRequest.time}" class="form-input">
                                </div>
                                <div class="flex items-center gap-2 h-[42px] bg-white px-3 rounded-lg border border-slate-200">
                                    <input type="checkbox" id="in-measure-paid" onchange="togglePaidAmount()" ${newClientForm.measureRequest.isPaid ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                                    <label for="in-measure-paid" class="text-sm text-slate-700 cursor-pointer select-none">مدفوع؟</label>
                                </div>
                                <div id="measure-amount-div" class="space-y-1 ${newClientForm.measureRequest.isPaid ? '' : 'hidden'}">
                                    <label class="text-xs font-bold text-slate-500">المبلغ</label>
                                    <input type="number" id="in-measure-amount" value="${newClientForm.measureRequest.amount}" class="form-input" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-6">
                            <label class="form-label">ملاحظات أخرى</label>
                            <textarea id="in-notes" class="form-input h-24 resize-none" placeholder="أي تفاصيل إضافية...">${newClientForm.notes}</textarea>
                        </div>

                        <div class="flex flex-wrap gap-3 justify-end border-t border-slate-100 pt-4">
                            <button onclick="notifyClient()" class="bg-green-600 text-white px-6 py-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-lg shadow-green-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                            </button>
                            <button onclick="sendToMeasurements()" class="bg-purple-600 text-white px-6 py-2.5 rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="ruler" class="w-4 h-4"></i> إرسال لرفع المقاسات
                            </button>
                            <button onclick="saveNewClient()" class="bg-[#0f3057] text-white px-8 py-2.5 rounded-lg hover:bg-[#1a4b82] flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="save" class="w-4 h-4"></i> حفظ البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Clients Table -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="list" class="w-5 h-5 text-slate-400"></i> سجل العملاء
                            </h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-1 rounded-full font-bold">${data.length} عميل</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th class="p-4">بيانات العميل</th>
                                        <th class="p-4">الجوال</th>
                                        <th class="p-4">المشاريع</th>
                                        <th class="p-4">الحالة</th>
                                        <th class="p-4 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${data.map(c => `
                                        <tr class="hover:bg-blue-50/30 transition-colors group">
                                            <td class="p-4">
                                                <div class="font-bold text-[#0f3057] text-base">${c.name}</div>
                                                <div class="text-xs text-slate-400 font-mono flex items-center gap-1">
                                                    <span class="bg-slate-100 px-1 rounded">${c.code}</span>
                                                    ${c.type === 'شركات' ? '<span class="bg-orange-100 text-orange-700 px-1 rounded">شركة</span>' : ''}
                                                </div>
                                            </td>
                                            <td class="p-4 font-mono dir-ltr text-right text-slate-600">${c.phone}</td>
                                            <td class="p-4">
                                                <div class="flex gap-1 flex-wrap">
                                                    ${Object.entries(c.projectDetails).map(([k, v]) => v > 0 ? 
                                                        `<span class="text-[10px] bg-white border border-slate-200 px-1.5 py-0.5 rounded text-slate-600 shadow-sm">${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'نوم' : k} <b class="text-blue-600">${v}</b></span>` 
                                                        : '').join('')}
                                                </div>
                                            </td>
                                            <td class="p-4">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(c.status)}">
                                                    ${getStatusLabel(c.status)}
                                                </span>
                                            </td>
                                            <td class="p-4">
                                                <div class="flex items-center justify-center gap-2">
                                                    <button onclick="openWhatsAppModal(${c.id})" class="p-2 text-green-600 bg-green-50 rounded-lg hover:bg-green-100 transition-colors" title="واتساب">
                                                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="openClientModal(${c.id})" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors" title="التفاصيل">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${data.length === 0 ? '<div class="p-10 text-center text-slate-400 flex flex-col items-center"><i data-lucide="inbox" class="w-12 h-12 mb-2 opacity-20"></i>لا توجد بيانات للعرض</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 2. Measurements View
        function renderMeasurementsView(data) {
            const selectedClient = selectedClientId ? clients.find(c => c.id == selectedClientId) : null;
            const projectDetails = selectedClient ? selectedClient.projectDetails : { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 };
            const appointment = selectedClient?.appointment || { date: '', time: '', status: 'pending' };
            
            return `
                <div class="space-y-6 max-w-5xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 border-t-4 border-t-indigo-500">
                        <div class="mb-8 border-b border-slate-100 pb-4">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                <span class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="ruler" class="w-6 h-6"></i></span>
                                تفاصيل المشروع والمقاسات
                            </h2>
                            <p class="text-slate-500 mt-1 mr-12 text-sm">إدارة ملفات الرفع المساحي والوسائط</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="space-y-1">
                                <label class="form-label">اسم العميل</label>
                                <div class="relative">
                                    <select onchange="selectClientForMeasure(this.value)" class="form-input appearance-none bg-white cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientId ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                             <div class="space-y-1">
                                <label class="form-label">رقم الجوال</label>
                                <input type="text" value="${selectedClient ? selectedClient.phone : ''}" readonly class="form-input bg-slate-50 text-slate-500">
                            </div>
                             <div class="space-y-1">
                                <label class="form-label">حالة المقاسات</label>
                                <div class="form-input bg-slate-50 flex items-center justify-between">
                                    <span class="${selectedClient && selectedClient.measurements.status === 'completed' ? 'text-green-600 font-bold' : 'text-slate-500'}">
                                        ${selectedClient ? (selectedClient.measurements.status === 'completed' ? 'مكتمل' : 'معلق') : '-'}
                                    </span>
                                    ${selectedClient && selectedClient.measurements.status === 'completed' ? '<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- 1. Appointment Section -->
                        <div class="bg-blue-50/50 p-6 rounded-xl border border-blue-100 mb-8 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <h4 class="text-sm font-bold text-blue-800 mb-4 flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i> تحديد موعد القياس
                            </h4>
                            <div class="flex flex-wrap items-end gap-4">
                                <div class="space-y-1 flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="measure-date" value="${appointment.date}" class="form-input">
                                </div>
                                <div class="space-y-1 flex-1 min-w-[150px]">
                                    <label class="text-xs font-bold text-slate-500">وقت الزيارة</label>
                                    <input type="time" id="measure-time" value="${appointment.time}" class="form-input">
                                </div>
                                <button onclick="saveAppointment()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 shadow-sm font-bold transition-colors h-[42px]">
                                    حفظ الموعد
                                </button>
                            </div>
                        </div>

                        <!-- 2. Measurement Items Uploads -->
                        <div class="space-y-6 mb-8 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <div class="flex items-center justify-between">
                                <label class="form-label text-base">تفاصيل الرفع المساحي (صور/فيديو + كروكي):</label>
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">يتم الرفع لكل بند على حدة</span>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-4">
                                ${selectedClient ? getMeasurementItems(selectedClient).map(item => `
                                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors">
                                        <h5 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                            <span class="w-2 h-2 rounded-full bg-indigo-500"></span> ${item.label}
                                        </h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="upload-zone bg-slate-50 border-slate-200 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all h-32">
                                                <i data-lucide="image" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                <span class="text-xs font-bold text-slate-600">صور/فيديو الموقع (قبل)</span>
                                                <span class="text-[10px] text-slate-400 mt-1">JPG, MP4</span>
                                            </div>
                                            <div class="upload-zone bg-slate-50 border-slate-200 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition-all h-32">
                                                <i data-lucide="pen-tool" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                <span class="text-xs font-bold text-slate-600">كروكي المقاسات</span>
                                                <span class="text-[10px] text-slate-400 mt-1">PDF, PNG</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center py-8 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">اختر عميلاً لعرض البنود</div>'}
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 justify-end pt-4 border-t border-slate-100 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <button onclick="notifyClientMeasurement()" class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 shadow-lg shadow-green-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                            </button>
                            <button onclick="sendToDesign()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 shadow-lg shadow-purple-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="send" class="w-4 h-4"></i> إرسال للتصميم
                            </button>
                            <button onclick="handleSaveMeasurements()" class="bg-[#0f3057] text-white px-6 py-2.5 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="save" class="w-4 h-4"></i> تم رفع المقاسات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 3. Design View
        function renderDesignView(data) {
            const selectedClient = selectedClientForDesignId ? clients.find(c => c.id == selectedClientForDesignId) : null;

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 border-t-4 border-t-purple-500 h-full overflow-y-auto custom-scrollbar">
                            <div class="mb-6 border-b border-slate-100 pb-4">
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <span class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="pen-tool" class="w-5 h-5"></i></span>
                                    التسعير والعقد
                                </h2>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <label class="form-label">اختيار العميل</label>
                                <div class="relative">
                                    <select onchange="selectClientForDesign(this.value)" class="form-input appearance-none bg-slate-50 cursor-pointer">
                                        <option value="">اختر عميل للتسعير...</option>
                                        ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientForDesignId ? 'selected' : ''}>${c.name} - ${getStatusLabel(c.status)}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="space-y-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm transition-all' : 'transition-all'}">
                                <div class="bg-purple-50 p-6 rounded-xl border border-purple-100">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="space-y-1">
                                            <label class="form-label text-purple-800">قيمة الكوتيشن الإجمالية (ريال)</label>
                                            <div class="relative">
                                                <input type="number" id="design-total" value="${selectedClient?.design.total || ''}" class="form-input text-lg font-bold text-purple-700 pr-10 border-purple-200 focus:border-purple-500 focus:ring-purple-200" placeholder="0">
                                                <span class="absolute left-3 top-2.5 text-xs text-purple-400 font-bold">SAR</span>
                                            </div>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="form-label text-purple-800">قيمة الدفعة الأولى (ريال)</label>
                                            <div class="relative">
                                                <input type="number" id="design-first" value="${selectedClient?.design.firstPayment || ''}" class="form-input text-lg font-bold text-slate-700 pr-10 border-purple-200" placeholder="0">
                                                <span class="absolute left-3 top-2.5 text-xs text-slate-400 font-bold">SAR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="pt-6 border-t border-slate-100">
                                    <div class="bg-white border border-slate-200 rounded-xl p-4 mb-4 flex items-start gap-3">
                                        <input type="checkbox" id="signed" ${selectedClient?.design.signed ? 'checked' : ''} class="w-5 h-5 text-purple-600 rounded mt-0.5 cursor-pointer accent-purple-600">
                                        <div>
                                            <label for="signed" class="font-bold text-slate-700 select-none cursor-pointer block">تأكيد توقيع العميل على العقد</label>
                                            <p class="text-xs text-slate-500 mt-1">عند التفعيل، ستتغير حالة العميل إلى "تم الاتفاق" ويمكن البدء بالتنفيذ.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="handleSaveDesign()" class="flex-1 bg-purple-600 text-white hover:bg-purple-700 py-3 rounded-lg font-bold transition shadow-lg shadow-purple-200 flex justify-center gap-2">
                                            <i data-lucide="file-check" class="w-5 h-5"></i> حفظ وإصدار العقد
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 h-full flex flex-col">
                            <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">ملف العميل المختصر</h3>
                            <div class="flex-1">
                                ${selectedClient ? `
                                    <div class="text-center mb-6">
                                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-slate-600">
                                            ${selectedClient.name.charAt(0)}
                                        </div>
                                        <p class="font-bold text-lg text-slate-800">${selectedClient.name}</p>
                                        <p class="text-sm text-slate-400 font-mono">${selectedClient.code}</p>
                                    </div>
                                    <div class="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">الحالة الحالية:</span> 
                                            <span class="font-bold px-2 py-0.5 rounded bg-white border border-slate-200 text-xs">${getStatusLabel(selectedClient.status)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">المقاسات:</span> 
                                            <span class="font-bold ${selectedClient.measurements.status === 'completed' ? 'text-green-600' : 'text-orange-500'}">
                                                ${selectedClient.measurements.status === 'completed' ? 'تمت' : 'لم تتم'}
                                            </span>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="h-full flex flex-col items-center justify-center text-slate-300">
                                        <i data-lucide="user" class="w-16 h-16 mb-2 opacity-50"></i>
                                        <p>اختر عميلاً لعرض التفاصيل</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 4. Installation View
        function renderInstallationView(data) {
            const selectedClient = selectedClientForInstallId ? clients.find(c => c.id == selectedClientForInstallId) : null;

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                          <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 border-t-4 border-t-orange-500">
                            <div class="flex justify-between items-center mb-6">
                              <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                <span class="p-2 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="wrench" class="w-5 h-5"></i></span>
                                تفاصيل المشروع والتركيب
                              </h3>
                            </div>

                            <div class="mb-6">
                                <label class="form-label">اختيار العميل (مرحلة التركيب)</label>
                                <div class="relative">
                                    <select onchange="selectClientForInstall(this.value)" class="form-input appearance-none bg-slate-50 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.filter(c => c.design.signed).map(c => `<option value="${c.id}" ${c.id == selectedClientForInstallId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''}">
                              <div class="space-y-1">
                                <label class="form-label">رقم الوظيفة (Job No)</label>
                                <input type="text" id="install-job" value="${selectedClient?.installation.jobNo || ''}" class="form-input bg-slate-50 text-right font-mono" placeholder="J-XXXX">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">تاريخ بدء التركيب</label>
                                <input type="date" id="install-start" value="${selectedClient?.installation.startDate || ''}" class="form-input">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">الدفعة الأخيرة (ريال)</label>
                                <div class="relative">
                                    <input type="number" id="install-last-pay" value="${selectedClient?.installation.lastPayment || ''}" class="form-input pr-10" placeholder="0">
                                    <span class="absolute left-3 top-2.5 text-xs text-slate-400 font-bold">SAR</span>
                                </div>
                              </div>
                            </div>

                            <div class="mt-8 flex gap-3 justify-end pt-4 border-t border-slate-100">
                               <button onclick="handleSaveInstallation()" class="bg-orange-500 text-white px-6 py-2.5 rounded-lg hover:bg-orange-600 flex items-center gap-2 shadow-lg shadow-orange-200 transition-all font-bold ${!selectedClient ? 'hidden' : ''}">
                                   <i data-lucide="calendar-check" class="w-5 h-5"></i> تحديث وجدولة
                               </button>
                            </div>
                          </div>
                        </div>
                        
                        <div class="lg:col-span-1 space-y-4">
                             <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> إحصائيات التركيب</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <span class="text-sm text-blue-800">بالانتظار</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-blue-600 font-bold shadow-sm">${clients.filter(c => c.status === 'design' && c.design.signed).length}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                                        <span class="text-sm text-orange-800">جاري التركيب</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-orange-600 font-bold shadow-sm">${clients.filter(c => c.status === 'installation').length}</span>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 5. Offers View
        function renderOffersView(data) {
            const offers = clients.filter(c => c.design.total > 0);
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('إجمالي العروض', offers.length, 'file-text', 'bg-blue-600', 'text-white')}
                        ${renderStatCard('قيمة العروض', offers.reduce((a,b) => a + (parseInt(b.design.total)||0), 0).toLocaleString() + ' ريال', 'dollar-sign', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('تم التعاقد', offers.filter(c => c.design.signed).length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">قائمة عروض الأسعار والفواتير</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 text-slate-500 border-b border-slate-100">
                                    <tr>
                                        <th class="p-4">رقم العرض</th>
                                        <th class="p-4">العميل</th>
                                        <th class="p-4">القيمة الإجمالية</th>
                                        <th class="p-4">الدفعة الأولى</th>
                                        <th class="p-4">الحالة</th>
                                        <th class="p-4 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${offers.length > 0 ? offers.map(c => `
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="p-4 font-mono text-slate-500">${c.code}-QT</td>
                                            <td class="p-4 font-bold text-slate-800">${c.name}</td>
                                            <td class="p-4 text-slate-800 font-bold">${parseInt(c.design.total).toLocaleString()} ريال</td>
                                            <td class="p-4 text-green-600">${parseInt(c.design.firstPayment).toLocaleString()} ريال</td>
                                            <td class="p-4">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold ${c.design.signed ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                                    ${c.design.signed ? 'تم التعاقد' : 'بانتظار الموافقة'}
                                                </span>
                                            </td>
                                            <td class="p-4 text-center">
                                                <button class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors">
                                                    <i data-lucide="printer" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" class="text-center py-10 text-slate-400">لا توجد عروض أسعار مسجلة</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. Reports View
        function renderReportsView(data) {
            return `
                <div class="p-10 text-center bg-white rounded-2xl shadow-sm border border-slate-100">
                    <i data-lucide="pie-chart" class="w-16 h-16 mx-auto text-slate-200 mb-4"></i>
                    <h3 class="text-xl font-bold text-slate-700">التقارير</h3>
                    <p class="text-slate-400 mt-2">صفحة التقارير قيد التطوير...</p>
                </div>
            `;
        }

        // --- Helper Renderers ---
        function renderStatCard(title, val, icon, bgClass, textClass, borderClass = '') {
            return `
                <div class="rounded-xl shadow-sm p-5 flex justify-between items-center ${bgClass} ${borderClass} transition-transform hover:-translate-y-1">
                    <div class="${textClass}">
                        <p class="text-sm opacity-80 font-medium mb-1">${title}</p>
                        <p class="text-3xl font-bold">${val}</p>
                    </div>
                    <div class="p-3 rounded-lg bg-white/20 backdrop-blur-sm ${textClass}">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                </div>
            `;
        }

        function renderCounter(label, key) {
            return `
                <div class="flex flex-col bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                    <span class="text-xs font-bold text-slate-500 mb-2 text-center block">${label}</span>
                    <div class="flex items-center justify-between bg-slate-50 rounded">
                        <button onclick="updateCount('${key}', -1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors font-bold text-lg">-</button>
                        <span id="count-${key}" class="font-bold text-slate-700 text-sm">${newClientForm.projectDetails[key]}</span>
                        <button onclick="updateCount('${key}', 1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-green-500 hover:bg-green-50 rounded transition-colors font-bold text-lg">+</button>
                    </div>
                </div>
            `;
        }

        function renderUploadZone(icon, label, subLabel, styleClass) {
            // styleClass example: 'bg-blue-50 border-blue-200 text-blue-500'
            const [bg, border, text] = styleClass.split(' ');
            return `
                <div class="upload-zone ${bg} ${border} p-8 text-center cursor-pointer group">
                    <div class="flex justify-center mb-3">
                        <div class="p-4 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200">
                            <i data-lucide="${icon}" class="${text} w-6 h-6"></i>
                        </div>
                    </div>
                    <h4 class="font-bold text-slate-700 mb-1 group-hover:text-blue-600 transition-colors">${label}</h4>
                    <p class="text-xs text-slate-400">${subLabel}</p>
                </div>
            `;
        }

        function getStatusLabel(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.label : s; }
        function getStatusColor(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.color : 'bg-gray-100'; }

        // --- Logic Handlers ---
        function attachInputListeners() {
            const n = document.getElementById('in-name'), p = document.getElementById('in-phone'), e = document.getElementById('in-email'), a = document.getElementById('in-address'), t = document.getElementById('in-type');
            const w = document.getElementById('in-whatsapp'), l = document.getElementById('in-location'), s = document.getElementById('in-source'), tx = document.getElementById('in-tax'), st = document.getElementById('in-status'), nt = document.getElementById('in-notes');
            const md = document.getElementById('in-measure-date'), mt = document.getElementById('in-measure-time'), ma = document.getElementById('in-measure-amount');

            if(n) n.oninput = (ev) => newClientForm.name = ev.target.value;
            if(p) p.oninput = (ev) => newClientForm.phone = ev.target.value;
            if(e) e.oninput = (ev) => newClientForm.email = ev.target.value;
            if(a) a.oninput = (ev) => newClientForm.address = ev.target.value;
            if(t) t.onchange = (ev) => { newClientForm.type = ev.target.value; render(); };
            if(w) w.oninput = (ev) => newClientForm.whatsapp = ev.target.value;
            if(l) l.oninput = (ev) => newClientForm.location = ev.target.value;
            if(s) s.onchange = (ev) => newClientForm.source = ev.target.value;
            if(tx) tx.oninput = (ev) => newClientForm.taxId = ev.target.value;
            if(st) st.onchange = (ev) => newClientForm.clientStatus = ev.target.value;
            if(nt) nt.oninput = (ev) => newClientForm.notes = ev.target.value;
            if(md) md.oninput = (ev) => newClientForm.measureRequest.date = ev.target.value;
            if(mt) mt.oninput = (ev) => newClientForm.measureRequest.time = ev.target.value;
            if(ma) ma.oninput = (ev) => newClientForm.measureRequest.amount = ev.target.value;
        }

        function updateCount(k, d) {
            newClientForm.projectDetails[k] = Math.max(0, newClientForm.projectDetails[k] + d);
            render(); 
        }

        function addCompanyItem() {
            const name = document.getElementById('comp-item-name').value;
            const qty = document.getElementById('comp-item-qty').value;
            if(name && qty > 0) {
                newClientForm.customProjects.push({ name, qty });
                render();
            }
        }

        function removeCompanyItem(idx) {
            newClientForm.customProjects.splice(idx, 1);
            render();
        }

        function togglePaidAmount() {
            const isPaid = document.getElementById('in-measure-paid').checked;
            newClientForm.measureRequest.isPaid = isPaid;
            render();
        }

        function saveNewClient(targetStatus = null) {
            if(!newClientForm.name || !newClientForm.phone) return alert('الاسم ورقم الجوال مطلوبان');
            if(clients.some(c => c.phone === newClientForm.phone)) return alert('رقم الجوال مسجل مسبقاً!');

            const client = {
                ...newClientForm,
                id: Date.now(),
                status: targetStatus || newClientForm.clientStatus || 'potential',
                employeeId: currentUser.id,
                logs: [{ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تسجيل جديد' }],
                measurements: { status: 'pending', date: '', files: [] },
                appointment: { date: '', time: '', status: 'pending' },
                design: { status: 'pending', total: 0, firstPayment: 0, signed: false },
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                invoices: []
            };

            if(targetStatus === 'measurements') {
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم القياسات' });
            }

            clients.unshift(client);
            
            newClientForm = { 
                code: generateCode(), 
                name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
                type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
                projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
                customProjects: [],
                notes: '',
                measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
            };
            
            saveClients();
            alert('تم الحفظ بنجاح');
        }

        function sendToMeasurements() {
            if(confirm('هل أنت متأكد من حفظ البيانات وإرسالها لقسم رفع المقاسات؟')) {
                saveNewClient('measurements');
            }
        }

        function notifyClient() {
            const phone = newClientForm.whatsapp || newClientForm.phone;
            if(!phone) return alert('يرجى إدخال رقم الجوال أو الواتساب أولاً');
            
            const msg = `مرحباً ${newClientForm.name}،\nسعدنا بتواصلك مع بيت الخزائن.\nتم تسجيل بياناتك بنجاح برقم ملف: ${newClientForm.code}\nسيقوم فريقنا بالتواصل معك قريباً.`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function selectClientForMeasure(id) { selectedClientId = id; render(); }
        function selectClientForDesign(id) { selectedClientForDesignId = id; render(); }
        function selectClientForInstall(id) { selectedClientForInstallId = id; render(); }

        function saveAppointment() {
            if (!selectedClientId) return;
            const date = document.getElementById('measure-date').value;
            const time = document.getElementById('measure-time').value;
            if(!date || !time) return alert('يرجى تحديد التاريخ والوقت');
            
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                client.appointment = { date, time, status: 'scheduled' };
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: `تم تحديد موعد قياس: ${date} ${time}` });
                saveClients();
                alert('تم حفظ الموعد بنجاح');
            }
        }

        function getMeasurementItems(client) {
            let items = [];
            if (client.type === 'شركات' && client.customProjects && client.customProjects.length > 0) {
                client.customProjects.forEach((p, i) => items.push({ id: `custom-${i}`, label: `${p.name} (العدد: ${p.qty})` }));
            } else {
                const map = { kitchen: 'مطبخ', bedroom: 'غرفة نوم', cladding: 'تجليد', doors: 'أبواب', vanity: 'خزائن', tvUnit: 'وحدة TV' };
                Object.entries(client.projectDetails).forEach(([key, count]) => {
                    if (count > 0) {
                        for(let i=1; i<=count; i++) items.push({ id: `${key}-${i}`, label: `${map[key] || key} ${count > 1 ? i : ''}` });
                    }
                });
            }
            return items;
        }

        function handleSaveMeasurements() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                client.measurements.status = 'completed';
                client.measurements.date = new Date().toLocaleDateString('en-US');
                client.status = 'measurements';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم رفع المقاسات' });
                saveClients();
                render();
                alert('تم حفظ المقاسات وتحديث الحالة');
            }
        }

        function sendToDesign() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                if(client.measurements.status !== 'completed') {
                    if(!confirm('لم يتم تأكيد رفع المقاسات بعد. هل تريد المتابعة؟')) return;
                }
                client.status = 'design';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم التصميم' });
                saveClients();
                render();
                alert('تم إرسال العميل لقسم التصميم');
            }
        }

        function notifyClientMeasurement() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                let msg = `مرحباً ${client.name}،\n`;
                if(client.appointment && client.appointment.status === 'scheduled') {
                    msg += `تم تحديد موعد لرفع المقاسات بتاريخ ${client.appointment.date} الساعة ${client.appointment.time}.`;
                } else if (client.measurements.status === 'completed') {
                    msg += `تم الانتهاء من رفع المقاسات بنجاح، وجاري العمل على التصميم.`;
                } else {
                    msg += `نود إبلاغك بمستجدات مشروعك لدى بيت الخزائن.`;
                }
                const url = `https://wa.me/${client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
        }

        function handleSaveDesign() {
            if (!selectedClientForDesignId) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client) {
                const total = document.getElementById('design-total').value;
                const first = document.getElementById('design-first').value;
                const signed = document.getElementById('signed').checked;

                client.design.total = total;
                client.design.firstPayment = first;
                client.design.signed = signed;
                
                if (signed) {
                    client.design.status = 'approved';
                    client.status = 'design';
                }
                saveClients();
                alert('تم حفظ بيانات العقد والتسعير');
            }
        }

        function handleSaveInstallation() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                client.installation.jobNo = document.getElementById('install-job').value;
                client.installation.startDate = document.getElementById('install-start').value;
                client.installation.lastPayment = document.getElementById('install-last-pay').value;
                client.status = 'installation';
                saveClients();
                alert('تم جدولة التركيب بنجاح');
            }
        }

        function openClientModal(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            const modal = document.getElementById('clientModal');
            modal.innerHTML = `
                <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-scaleIn max-h-[90vh] flex flex-col">
                    <div class="bg-[#0f3057] text-white p-5 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">${client.name}</h2>
                            <p class="text-sm text-blue-200 font-mono mt-1">${client.code} | ${client.phone}</p>
                        </div>
                        <button onclick="document.getElementById('clientModal').classList.add('hidden')" class="hover:bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="p-8 text-center text-slate-500">تفاصيل العميل (قيد التطوير في العرض المحسن)</div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function openWhatsAppModal(id) {
             const c = clients.find(x => x.id === id);
             if(!c) return;
             const url = `https://wa.me/${c.phone}`;
             window.open(url, '_blank');
        }

        init();
    </script>
</body>
</html>
